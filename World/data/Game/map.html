<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Visualizador de Mapa</title>
    <style>
        body {
            font-family: system-ui, Segoe UI, Arial, sans-serif;
            margin: 16px;
            background: #f7f7f9;
            color: #222
        }

        .wrap {
            display: flex;
            gap: 16px;
            align-items: flex-start
        }

        .panel {
            min-width: 200px
        }

        .legend {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 6px 10px;
            align-items: center
        }

        .chip {
            width: 16px;
            height: 16px;
            display: inline-block;
            border: 1px solid #666
        }

        .green {
            background: #2ecc71
        }

        .red {
            background: #e74c3c
        }

        .yellow {
            background: #f1c40f
        }

        .border {
            background: #000
        }

        canvas {
            image-rendering: pixelated;
            border: 1px solid #000;
            background: #fff
        }

        .controls {
            margin-bottom: 8px
        }

        input[type=number] {
            width: 64px
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="panel">
            <div class="controls">
                <label>Zona: <input id="zoneName" type="text" value="square1"></label><br>
                <label>Ghost zone (tiles): <input id="gz" type="number" min="0" max="8" step="1" value="1"></label>
                <button id="drawBtn">Desenhar</button>
                <button id="fetchBtn">Carregar via fetch</button><br>
                <label>Selecionar JSONs: <input id="fileInput" type="file" accept=".json" multiple></label>
                <div style="margin-top:6px">Zona atual: <span id="currentZone">—</span></div>
            </div>
            <div class="legend">
                <span class="chip green"></span><span>Andável</span>
                <span class="chip red"></span><span>Bloqueado</span>
                <span class="chip yellow"></span><span>Ghost zone</span>
                <span class="chip border"></span><span>Fronteira</span>
            </div>
            <div id="info" style="margin-top:8px;font-size:12px"></div>
        </div>
        <canvas id="mapCanvas"></canvas>
        <script id="mapJson" type="application/json">
{
    "width": 18,
    "height": 10,
    "tiles": [
        {
            "x": -9,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": -5,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": -4,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": -3,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": -2,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": -1,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": 0,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": 1,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": 2,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": 3,
            "tileId": "0"
        },
        {
            "x": -9,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": -8,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": -7,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": -6,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": -5,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": -4,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": -3,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": -2,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": -1,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 0,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 1,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 2,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 3,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 4,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 5,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 6,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 7,
            "y": 4,
            "tileId": "0"
        },
        {
            "x": 8,
            "y": 4,
            "tileId": "0"
        }
    ],
    "objects": [
        {
            "x": -3,
            "y": -1,
            "objectId": "01"
        }
    ]
}
  </script>
        <script id="tileJson" type="application/json">
[
   {
       "tileId": "0",
       "nome": "WalkableCanSee",
       "isWalkable": true,
       "blocksVision": false
   }
]
  </script>
        <script id="objectJson" type="application/json">
[
   {
       "objectId": "",
       "nome": "",
       "blocksMovement": false,
       "interactable": false
   },
   {
       "objectId": "01",
       "nome": "NoMoveNoInteractable",
       "blocksMovement": true,
       "interactable": false
   }
]
  </script>
    </div>
    <script>
        const tileSize = 16;
        function parseJson(id) { const el = document.getElementById(id); return el ? JSON.parse(el.textContent) : null }
        let map = parseJson('mapJson');
        let tileDefsArr = parseJson('tileJson') || [];
        let objectDefsArr = parseJson('objectJson') || [];
        let regionsData = null;
        let tileDefs = {}, objectDefs = {}, tiles = [], objByPos = {}, tileByPos = {};
        let minX = 0, maxX = 0, minY = 0, maxY = 0, cols = 0, rows = 0, offsetX = 0, offsetY = 0;
        let player = { x: 0, y: 0 };
        function setup() {
            tileDefs = {}; for (const t of tileDefsArr) { tileDefs[t.tileId] = t }
            objectDefs = {}; for (const o of objectDefsArr) { objectDefs[o.objectId] = o }
            tiles = map?.tiles || [];
            minX = Infinity; maxX = -Infinity; minY = Infinity; maxY = -Infinity;
            for (const t of tiles) { if (t.x < minX) minX = t.x; if (t.x > maxX) maxX = t.x; if (t.y < minY) minY = t.y; if (t.y > maxY) maxY = t.y }
            cols = maxX - minX + 1; rows = maxY - minY + 1;
            offsetX = -minX; offsetY = -minY;
            objByPos = {}; if (map?.objects) { for (const o of map.objects) { objByPos[`${o.x},${o.y}`] = o } }
            tileByPos = {}; for (const t of tiles) { tileByPos[`${t.x},${t.y}`] = t }
            player = { x: 0, y: 0 }; if (!tileByPos[`${player.x},${player.y}`]) { player = { x: minX, y: minY } }
        }
        async function fetchJson(path) { const r = await fetch(path, { cache: 'no-store' }); if (!r.ok) throw new Error('fail'); return await r.json() }
        async function loadViaFetch() {
            try {
                const m = await fetchJson('map.json');
                const t = await fetchJson('tile_definitions.json');
                const o = await fetchJson('object_definitions.json');
                let reg = null;
                try { reg = await fetchJson('world.regions.json') } catch { }
                map = m; tileDefsArr = t; objectDefsArr = o; regionsData = reg;
                setup(); draw();
            } catch {
                const info = document.getElementById('info');
                info.textContent = 'Falha ao ler via fetch. Use Selecionar JSONs.';
            }
        }
        function drawRegions(ctx) {
            if (!regionsData || !Array.isArray(regionsData.regions)) return;
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1;
            ctx.fillStyle = 'rgba(0,0,0,0.35)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '12px Segoe UI, Arial';
            for (const r of regionsData.regions) {
                const rx = (r.minX + offsetX) * tileSize;
                const ry = (r.minY + offsetY) * tileSize;
                const rw = (r.maxX - r.minX + 1) * tileSize;
                const rh = (r.maxY - r.minY + 1) * tileSize;
                ctx.strokeRect(rx, ry, rw, rh);
                ctx.fillText(r.name, rx + rw / 2, ry + rh / 2);
            }
        }
        function drawGhostZoneForRegion(ctx, gzTiles) {
            if (!regionsData || !Array.isArray(regionsData.regions)) return;
            const zone = document.getElementById('zoneName').value || '';
            const r = regionsData.regions.find(a => a.name.toLowerCase() === zone.toLowerCase());
            if (!r) return;
            const rx = (r.minX + offsetX) * tileSize;
            const ry = (r.minY + offsetY) * tileSize;
            const rw = (r.maxX - r.minX + 1) * tileSize;
            const rh = (r.maxY - r.minY + 1) * tileSize;
            const g = Math.max(0, Math.min(rw / tileSize, gzTiles)) * tileSize;
            ctx.globalAlpha = 0.35;
            ctx.fillStyle = '#f1c40f';
            ctx.fillRect(rx, ry, g, rh);
            ctx.fillRect(rx + rw - g, ry, g, rh);
            ctx.fillRect(rx, ry, rw, g);
            ctx.fillRect(rx, ry + rh - g, rw, g);
            ctx.globalAlpha = 1.0;
        }
        function draw() {
            if (!map || tiles.length === 0) { const info = document.getElementById('info'); info.textContent = 'Carregue map.json, tile_definitions.json e object_definitions.json.'; return }
            const gzTiles = Math.max(0, Math.min(cols, parseInt(document.getElementById('gz').value || '1')));
            const canvas = document.getElementById('mapCanvas');
            canvas.width = cols * tileSize;
            canvas.height = rows * tileSize;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (const t of tiles) {
                const def = tileDefs[t.tileId] || { isWalkable: false };
                const obj = objByPos[`${t.x},${t.y}`];
                const blockedByObj = obj && (objectDefs[obj.objectId]?.blocksMovement === true);
                const walk = def.isWalkable === true && !blockedByObj;
                ctx.fillStyle = walk ? '#2ecc71' : '#e74c3c';
                const sx = (t.x + offsetX) * tileSize;
                const sy = (t.y + offsetY) * tileSize;
                ctx.fillRect(sx, sy, tileSize, tileSize);
            }
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, cols * tileSize, rows * tileSize);
            drawRegions(ctx);
            drawGhostZoneForRegion(ctx, gzTiles);
            const px = (player.x + offsetX) * tileSize;
            const py = (player.y + offsetY) * tileSize;
            const pad = 3;
            ctx.fillStyle = '#3498db';
            ctx.fillRect(px + pad, py + pad, tileSize - 2 * pad, tileSize - 2 * pad);
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '14px Segoe UI, Arial';
            const zone = document.getElementById('zoneName').value || 'zona';
            ctx.fillText(zone, (cols * tileSize) / 2, (rows * tileSize) / 2);
            const info = document.getElementById('info');
            info.textContent = `Dimensões: ${cols}x${rows} tiles | Limites: x=[${minX},${maxX}] y=[${minY},${maxY}] | Ghost zone: ${gzTiles} tile(s) | Player: x=${player.x} y=${player.y}`;
            let current = '—';
            if (regionsData && Array.isArray(regionsData.regions)) {
                const r = regionsData.regions.find(a => player.x >= a.minX && player.x <= a.maxX && player.y >= a.minY && player.y <= a.maxY);
                if (r && r.name) current = r.name;
            }
            const cz = document.getElementById('currentZone'); if (cz) cz.textContent = current;
        }
        document.getElementById('drawBtn').addEventListener('click', draw);
        document.getElementById('fetchBtn').addEventListener('click', loadViaFetch);
        document.getElementById('fileInput').addEventListener('change', e => {
            const files = Array.from(e.target.files || []);
            const byName = {};
            for (const f of files) { byName[f.name.toLowerCase()] = f }
            const reader = (file) => new Promise((resolve, reject) => { const fr = new FileReader(); fr.onload = () => resolve(JSON.parse(fr.result)); fr.onerror = reject; fr.readAsText(file) });
            const tasks = [];
            if (byName['map.json']) tasks.push(reader(byName['map.json']).then(v => map = v));
            if (byName['tile_definitions.json']) tasks.push(reader(byName['tile_definitions.json']).then(v => tileDefsArr = v));
            if (byName['object_definitions.json']) tasks.push(reader(byName['object_definitions.json']).then(v => objectDefsArr = v));
            if (byName['world.regions.json']) tasks.push(reader(byName['world.regions.json']).then(v => regionsData = v));
            Promise.all(tasks).then(() => { setup(); draw() });
        });
        window.addEventListener('keydown', e => {
            let nx = player.x, ny = player.y;
            if (e.key === 'ArrowLeft') nx = player.x - 1;
            else if (e.key === 'ArrowRight') nx = player.x + 1;
            else if (e.key === 'ArrowUp') ny = player.y - 1;
            else if (e.key === 'ArrowDown') ny = player.y + 1;
            const inBounds = nx >= minX && nx <= maxX && ny >= minY && ny <= maxY;
            if (inBounds) {
                const t = tileByPos[`${nx},${ny}`];
                const def = t ? tileDefs[t.tileId] : null;
                const obj = objByPos[`${nx},${ny}`];
                const blocked = obj && (objectDefs[obj.objectId]?.blocksMovement === true);
                const walk = def && def.isWalkable === true && !blocked;
                if (walk) { player.x = nx; player.y = ny; draw() }
            }
        });
        setup(); draw();
        try { loadViaFetch(); } catch { }
    </script>
</body>

</html>